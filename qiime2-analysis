#Author: Diana E. Gutierrez
#Date: 08/27/2020
#Objective: analyze
#Software: qiime2
#Environment version: qiime2-2020.6

#####################################
# TIMED FEEDING MICROBIOME ANALYSIS #
#####################################

#This file contains the workflow used to analyze the microbiome data from week
#13 obtained from cohort 1 of the timed feeding experiment at the Bray lab

######## WARNING: this workflow is written for this dataset only, you can use it
######## as a guide for future analysis but it is not meant to be applied for
######## any and all datasets. Please get familiarized with the QIIME2 Software
######## by reading/following the extensive docummentation in the qiime2 website
######## IN DETAIL before attempting to run this workflow.

#To install qiime2 in your computer follow the instructions on the software
#documentation website. This workflow skips those steps and starts by initating
#the program

# To initiate the program activate the QIIME2 environment using conda

conda activate qiime2-2020.6

#The current installation instructions as of 08/27/2020 generate another qiime2
#environment version qiime2-2020.8 the syntax is slightly different from the
#one on the version I used when running this analysis so if any commands do not
#work check the help message that will show up and correct the commands

#Import the data to a qiime2 artifact
#####################################
#The manifest_single.tsv file contains the sampleid and ABSOLUTE PATHS to the
#forward reads for that specific sampleid it will generate the file
#single-end-demux.qza which is a qiime artifact that you will use in the rest
# of the analysis

#navigate to the timedfeeding folder, from here run the following code

            qiime tools import \
                --type 'SampleData[SequencesWithQuality]' \
                --input-path 4-18200-denoise-single-end/metadata/manifest_single.tsv \
                --output-path 3-single_data_import/single-end-demux.qza \
                --input-format SingleEndFastqManifestPhred33V2

#We can summarize the demultiplexed samples to look at their quality. (in our
#case we had already demultiplexed samples so this step didn't really do anything
#else but import the actual samples, but it is still good to summarize them)

            qiime demux summarize \
                --i-data 3-single_data_import/single-end-demux.qza \
                --o-visualization 3-single_data_import/single-end-demux.qzv
##  Question
##  After "demultiplexing", which sample has the lowest sequencing depth?
#   Samples at 4 am are the ones that have the lowest sequencing depth.


#    18x1x4 has the lowest sequencing depth with 954 reads
#    Median - 120924
#    Mean - 133123
#    MAX - 407369

    ##  What is the median sequence length?
#    120924

    ##  What is the median quality score at position 125?
#    38, any quality score higher than 20 represents 99% probability that the read
#    is correct

#    Phred Quality
#    Score
#          Probability of Incorrect Base Call Base Call Accuracy
#    10    1 in 10 90%
#    20    1 in 100 99%
#    30    1 in 1,000 99.9%
#    40    1 in 10,000 99.99%
#    50    1 in 100,000 99.999%

#Clicking on the "interactive Quality Plot" we can explore the quality of the data
#from the forward reads is pretty stable throughout the length of the fragments,
#on the other had the reverse reads are

#QIIME2 UTILIZES DADA2 FOR QUALITY CONTROL AND APPLIES THE QUALITY CONTROL STEP
#BEFORE THE MERGING OF THE SEQUENCES (in the case of pair-end sequences),
# COMPARED TO QIIME WHICH RESULTS IN A HIGHER NUMBER OF SEQUENCES MERGED.

#I LOOKED AT THE LITERATURE AND EVIDENCE SUGGESTS THAT:
#A GOOD THRESHOLD TO USE WHEN TRIMMING PAIR-END SEQUENCES USING DADA2 IN
#QUIIME2 IS 18. (see reference:  Mohsen, Attayeb, et al. "Impact of quality
#trimming on the efficiency of reads joining and diversity analysis of Illumina
#paired-end reads in the context of QIIME1 and QIIME2 microbiome analysis
#frameworks." BMC bioinformatics 20.1 (2019): 1-10.)

##########################
##FORWARD READS ANALYSIS##
##########################

#Because of the low quality of the reverse reads of the sequencing data we
#have decided to only use the forward reads and because of that we will use the
#single-end denoising method.

            qiime dada2 denoise-single \
                  --i-demultiplexed-seqs 3-single_data_import/single-end-demux.qza \
                  --p-trim-left 18 \
                  --p-trunc-len 200 \
                  --o-representative-sequences  4-18200-denoise-single-end/rep-seqs.qza \
                  --o-table  4-18200-denoise-single-end/table.qza \
                  --o-denoising-stats  4-18200-denoise-single-end/stats.qza

#This step took 6 hours for paired end reads and around one hour for single end reads!!!

#We summarize the feature table

                  qiime feature-table summarize \
                    --i-table table.qza \
                    --o-visualization table.qzv \
                    --m-sample-metadata-file metadata_all_categorical.tsv

#Tabulate the sequences and we can see using the visualization the frequency of
#each sequence we have in the samples

                  qiime feature-table tabulate-seqs \
                     --i-data rep-seqs.qza \
                     --o-visualization rep-seqs.qzv

                  qiime metadata tabulate \
                      --m-input-file q2_artfcts/stats.qza \
                      --o-visualization q2_vis/denoising-stats.qzv

#We can create a phylogeny tree
                  qiime phylogeny align-to-tree-mafft-fasttree \
                      --i-sequences q2_artfcts/rep-seqs.qza  \
                      --o-alignment q2_artfcts/aligned-rep-seqs.qza   \
                      --o-masked-alignment q2_artfcts/masked-aligned-rep-seqs.qza  \
                      --o-tree q2_artfcts/unrooted-tree.qza   \
                      --o-rooted-tree q2_artfcts/rooted-tree.qza






#After denoising you should have artifacts containing the feature table, feature
#sequences and DADA2 denoising stats. You can look at the summaries frorm all
#three of them as follows:

          qiime feature-table summarize \
            --i-table table.qza \
            --o-visualization table.qzv \
            --m-sample-metadata-file metadata_all_categorical.tsv

          qiime feature-table tabulate-seqs \
            --i-data rep-seqs.qza \
            --o-visualization rep-seqs.qzv

          qiime metadata tabulate \
            --m-input-file denoising-stats.qza \
            --o-visualization denoising-stats.qzv



##ONCE THE DATA HAS BEEN DENOISED WE CAN GENERATE THE PHYLOGENETIC tree
qiime phylogeny align-to-tree-mafft-fasttree \
--i-sequences rep-seqs.qza  \
--o-alignment aligned-rep-seqs.qza   \
--o-masked-alignment masked-aligned-rep-seqs.qza  \
--o-tree unrooted-tree.qza   \
--o-rooted-tree rooted-tree.qza

########### FILTER DATA ###################

#First we will apply metadata filtering methods because we know we don't
#want to focus on all samples

##To filter all baseline samples
qiime feature-table filter-samples \
  --i-table q2_artfcts/table.qza \
  --m-metadata-file metadata/metadata_all_categorical.tsv \
  --p-where "[week_name]='Week 13'"  \
  --o-filtered-table q2_artfcts/filtered/w13-fil-table.qza

##Filter animal 13 because we excluded it from the total metabolic analysis
qiime feature-table filter-samples \
  --i-table q2_artfcts/filtered/w13-fil-table.qza \
  --m-metadata-file metadata/metadata_all_categorical.tsv \
  --p-where "[animal_id]!=13" \
  --o-filtered-table q2_artfcts/13all-fil-table.qza

#You could also use the following code to filter both at the same time
qiime feature-table filter-samples --i-table q2_artfcts/table.qza \
  --m-metadata-file metadata/metadata_all_categorical.tsv \
  --p-where "[animal_id]!=13 AND [week_name]='Week 13'" \
  --o-filtered-table q2_artfcts/filtered/13all-fil-table.qza


########## SUMMARIZE THE TABLE ###########

## Filtered baseline and animal 13 samples
qiime feature-table summarize --i-table q2_artfcts/filtered/13all-fil-table.qza \
 --o-visualization q2_vis/13all-fil-table.qzv --m-sample-metadata-file metadata/metadata_all_categorical.tsv

#####OVERVIEW
# We can see in the visualizetion that we are left with only 178 samples that
# have a total of 3,938 features.
# We can also see that some of the features have a frequency of 2, 3 or 5 reads

#####INTERACTIVE SAMPLE DETAIL
# Looking at the interactive sample detail we can see that we are missing some
# samples from animal 16 and 23, and that we have one outlier sample that has
# very low number of features compared to the rest of the samples.

#If you change the metadata category to zt_time you can see that the samples we
#are missing both belong to zt_time 4. Changing it to sex we can see that we
#have less samples from females, this is because animal 13 which we filtered
#in the previous step is a female.

#If we look at the Feature Detail tab we can see that there are multiple Samples
#that are present in low frequency are present in only one sample.

# All of this information can be used to filter low abundance taxa that would
# not really affect the composition of the community and also may be a results
#of requencing error

#Before we continue with the analysis we will conduct some taxonomic and
#prevance filtering:




########## CALCULATE CORE DISTANCE METRICS ##############

##Without baseline samples
      qiime diversity core-metrics-phylogenetic \
        --i-phylogeny rooted-tree.qza \
        --i-table 13-fil-table.qza \
        --p-sampling-depth 3000 \
        --m-metadata-file metadata_all_categorical.tsv \
        --output-dir core-metrics-results

##without animal 13 also
      qiime diversity core-metrics-phylogenetic \
        --i-phylogeny rooted-tree.qza \
        --i-table fil_an13/13-fil-table.qza \
        --p-sampling-depth 3000 \
        --m-metadata-file metadata_all_categorical.tsv \
        --output-dir fil_an13/core-metrics-results


########### CHECKING ALPHA DIVERSITY ##############

##Without baseline and animal 13 samples
      qiime diversity alpha-group-significance \
        --i-alpha-diversity fil_an13/core-metrics-results/faith_pd_vector.qza \
        --m-metadata-file metadata_all_categorical.tsv \
        --o-visualization fil_an13/core-metrics-results/faith-pd-group-significance.qzv

      qiime diversity alpha-group-significance \
          --i-alpha-diversity fil_an13/core-metrics-results/evenness_vector.qza \
          --m-metadata-file metadata_all_categorical.tsv \
          --o-visualization fil_an13/core-metrics-results/evenness-group-significance.qzv


##### Beta diversity tests

qiime diversity beta-group-significance \
  --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file metadata_all_categorical.tsv \
  --m-metadata-column cat_zt_time \
  --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-zttime-significance.qzv \
  --p-pairwise

  qiime diversity beta-group-significance \
    --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
    --m-metadata-file metadata_all_categorical.tsv \
    --m-metadata-column sex_name \
    --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-sex-significance.qzv \
    --p-pairwise

    qiime diversity beta-group-significance \
      --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
      --m-metadata-file metadata_all_categorical.tsv \
      --m-metadata-column diet_group \
      --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-diet-significance.qzv \
      --p-pairwise


qiime emperor plot \
      --i-pcoa fil_an13/core-metrics-results/unweighted_unifrac_pcoa_results.qza \
      --m-metadata-file metadata_all_categorical.tsv \
      --p-custom-axes zt_time \
      --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-emperor-zttime.qzv


#######Visualize Rarefaction################

qiime diversity alpha-rarefaction \
  --i-table fil_an13/13-fil-table.qza \
  --i-phylogeny rooted-tree.qza \
  --p-max-depth 4000 \
  --m-metadata-file metadata_all_categorical.tsv \
  --o-visualization fil_an13/13alpha-4000rarefaction.qzv


  qiime diversity alpha-rarefaction \
    --i-table fil_an13/13-fil-table.qza \
    --i-phylogeny rooted-tree.qza \
    --p-max-depth 8000 \
    --m-metadata-file metadata_all_categorical.tsv \
    --o-visualization fil_an13/13alpha-8000rarefaction.qzv


#####Sequence classifier Greengenes ############

###first download the classifier
curl -sL \
  "https://data.qiime2.org/2020.6/common/gg-13-8-99-515-806-nb-classifier.qza" > \
  "gg-13-8-99-515-806-nb-classifier.qza"

qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza

###view the taxonomic composition of our samples with interactive bar plots

qiime taxa barplot \
  --i-table fil_an13/13-fil-table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file metadata_all_categorical.tsv \
  --o-visualization fil_an13/taxa-bar-plots.qzv
