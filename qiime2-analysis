#Import the data to a qiime2 artifact
#The tf_manifest.tsv file contains the sampleid and absolute paths to the forward and reverse reads for that specific sampleid
#it will generate the file paired-end-demux.qza which is a qiime artifact that you will use in the rest of the analysis


              qiime tools import \
                --type 'SampleData[PairedEndSequencesWithQuality]' \
                --input-path tf_manifest.tsv \
                --output-path paired-end-demux.qza \
                --input-format PairedEndFastqManifestPhred33V2

FIRST WE WILL CHECK THE SEQUENCES AND SEQUENCING DEPTH OF THE
SAMPLES USING THE qiime demux summarize COMMAND.

              qiime demux summarize \
                --i-data paired-end-demux.qza \
                --o-visualization demux-tf-all.qzv

    ##  Question
    ##  After demultiplexing, which sample has the lowest sequencing depth?
    Samples at 4 am are the ones that have the lowest sequencing depth.

    18x1x4 has the lowest sequencing depth with 954 reads
    Median - 120924
    Mean - 133123
    MAX - 407369

    ##  What is the median sequence length?
    120924

    ##  What is the median quality score at position 125?
    38, any quality score higher than 20 represents 99% probability that the read
    is correct

    Phred Quality
    Score
          Probability of Incorrect Base Call Base Call Accuracy
    10    1 in 10 90%
    20    1 in 100 99%
    30    1 in 1,000 99.9%
    40    1 in 10,000 99.99%
    50    1 in 100,000 99.999%

#Clicking on the "interactive Quality Plot" we can explore the quality of the data
#from the forward reads is pretty stable throughout the length of the fragments,
#on the other had the reverse reads are




#QIIME2 UTILIZES DADA2 FOR QUALITY CONTROL AND APPLIES THE QUALITY CONTROL STEP
#BEFORE THE MERGING OF THE SEQUENCES, COMPARED TO QIIME WHICH RESULTS IN A HIGHER
#NUMBER OF SEQUENCES MERGED. I LOOKED AT THE LITERATURE AND EVIDENCE SUGGESTS
# THAT A GOOD THRESHOLD TO USE WHEN TRIMMING PAIR-END SEQUENCES USING DADA2 IN
#QUIIME2 IS 18. (see reference:  Mohsen, Attayeb, et al. "Impact of quality
#trimming on the efficiency of reads joining and diversity analysis of Illumina
#paired-end reads in the context of QIIME1 and QIIME2 microbiome analysis
#frameworks." BMC bioinformatics 20.1 (2019): 1-10.)

#to denoise the samples we will use two parameters:


#18 to see what the "correct trimming variable looks like"
    qiime dada2 denoise-paired \
      --i-demultiplexed-seqs 3-data_import/paired-end-demux.qza \
      --p-trim-left-f 18 \
      --p-trim-left-r 18 \
      --p-trunc-len-f 240 \
      --p-trunc-len-r 160 \
      --o-table 4-denoise-18-18-240-160/table.qza \
      --o-representative-sequences 4-denoise-18-18-240-160/rep-seqs.qza \
      --o-denoising-stats 4-denoise-18-18-240-160/denoising-stats.qza

#This step took 6 hours!!!


#After denoising you should have artifacts containing the feature table, feature
#sequences and DADA2 denoising stats. You can look at the summaries frorm all
#three of them as follows:

          qiime feature-table summarize \
            --i-table table.qza \
            --o-visualization table.qzv \
            --m-sample-metadata-file metadata_all_categorical.tsv

          qiime feature-table tabulate-seqs \
            --i-data rep-seqs.qza \
            --o-visualization rep-seqs.qzv

          qiime metadata tabulate \
            --m-input-file denoising-stats.qza \
            --o-visualization denoising-stats.qzv



##ONCE THE DATA HAS BEEN DENOISED WE CAN GENERATE THE PHYLOGENETIC tree
qiime phylogeny align-to-tree-mafft-fasttree \
--i-sequences rep-seqs.qza  \
--o-alignment aligned-rep-seqs.qza   \
--o-masked-alignment masked-aligned-rep-seqs.qza  \
--o-tree unrooted-tree.qza   \
--o-rooted-tree rooted-tree.qza

########### FILTER DATA ###################

##To filter all baseline samples
qiime feature-table filter-samples   --i-table table.qza  --m-metadata-file metadata_all_categorical.tsv   --p-where "[week_name]='Week 13'"   --o-filtered-table 13-fil-table.qza


##Filter animal 13
qiime feature-table filter-samples   --i-table 13-fil-table.qza  --m-metadata-file metadata_all_categorical.tsv   --p-where "[animal_id]!=13"   --o-filtered-table fil_an13/13-fil-table.qza

qiime feature-table filter-samples   --i-table table.qza  --m-metadata-file metadata_all_categorical.tsv   --p-where "[animal_id]!=13 AND [week_name]='Week 13'"   --o-filtered-table 13-fil-table.qza


########## SUMMARIZE THE TABLE ###########

## filtered baseline week
qiime feature-table summarize --i-table 13-fil-table.qza --o-visualization 13-table.qzv --m-sample-metadata-file metadata_all_categorical.tsv



########## CALCULATE CORE DISTANCE METRICS ##############

##Without baseline samples
      qiime diversity core-metrics-phylogenetic \
        --i-phylogeny rooted-tree.qza \
        --i-table 13-fil-table.qza \
        --p-sampling-depth 3000 \
        --m-metadata-file metadata_all_categorical.tsv \
        --output-dir core-metrics-results

##without animal 13 also
      qiime diversity core-metrics-phylogenetic \
        --i-phylogeny rooted-tree.qza \
        --i-table fil_an13/13-fil-table.qza \
        --p-sampling-depth 3000 \
        --m-metadata-file metadata_all_categorical.tsv \
        --output-dir fil_an13/core-metrics-results


########### CHECKING ALPHA DIVERSITY ##############

##Without baseline and animal 13 samples
      qiime diversity alpha-group-significance \
        --i-alpha-diversity fil_an13/core-metrics-results/faith_pd_vector.qza \
        --m-metadata-file metadata_all_categorical.tsv \
        --o-visualization fil_an13/core-metrics-results/faith-pd-group-significance.qzv

      qiime diversity alpha-group-significance \
          --i-alpha-diversity fil_an13/core-metrics-results/evenness_vector.qza \
          --m-metadata-file metadata_all_categorical.tsv \
          --o-visualization fil_an13/core-metrics-results/evenness-group-significance.qzv


##### Beta diversity tests

qiime diversity beta-group-significance \
  --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file metadata_all_categorical.tsv \
  --m-metadata-column cat_zt_time \
  --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-zttime-significance.qzv \
  --p-pairwise

  qiime diversity beta-group-significance \
    --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
    --m-metadata-file metadata_all_categorical.tsv \
    --m-metadata-column sex_name \
    --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-sex-significance.qzv \
    --p-pairwise

    qiime diversity beta-group-significance \
      --i-distance-matrix fil_an13/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
      --m-metadata-file metadata_all_categorical.tsv \
      --m-metadata-column diet_group \
      --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-diet-significance.qzv \
      --p-pairwise


qiime emperor plot \
      --i-pcoa fil_an13/core-metrics-results/unweighted_unifrac_pcoa_results.qza \
      --m-metadata-file metadata_all_categorical.tsv \
      --p-custom-axes zt_time \
      --o-visualization fil_an13/core-metrics-results/unweighted-unifrac-emperor-zttime.qzv


#######Visualize Rarefaction################

qiime diversity alpha-rarefaction \
  --i-table fil_an13/13-fil-table.qza \
  --i-phylogeny rooted-tree.qza \
  --p-max-depth 4000 \
  --m-metadata-file metadata_all_categorical.tsv \
  --o-visualization fil_an13/13alpha-4000rarefaction.qzv


  qiime diversity alpha-rarefaction \
    --i-table fil_an13/13-fil-table.qza \
    --i-phylogeny rooted-tree.qza \
    --p-max-depth 8000 \
    --m-metadata-file metadata_all_categorical.tsv \
    --o-visualization fil_an13/13alpha-8000rarefaction.qzv


#####Sequence classifier Greengenes ############

###first download the classifier
curl -sL \
  "https://data.qiime2.org/2020.6/common/gg-13-8-99-515-806-nb-classifier.qza" > \
  "gg-13-8-99-515-806-nb-classifier.qza"

qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza

###view the taxonomic composition of our samples with interactive bar plots

qiime taxa barplot \
  --i-table fil_an13/13-fil-table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file metadata_all_categorical.tsv \
  --o-visualization fil_an13/taxa-bar-plots.qzv
